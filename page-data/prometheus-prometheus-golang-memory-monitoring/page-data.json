{"componentChunkName":"component---node-modules-gatsby-theme-andy-src-templates-note-js","path":"/prometheus-prometheus-golang-memory-monitoring","result":{"data":{"brainNote":{"slug":"prometheus-prometheus-golang-memory-monitoring","title":"prometheus-prometheus-golang-memory-monitoring","childMdx":{"body":"function _extends() { _extends = Object.assign || function (target) { for (var i = 1; i < arguments.length; i++) { var source = arguments[i]; for (var key in source) { if (Object.prototype.hasOwnProperty.call(source, key)) { target[key] = source[key]; } } } return target; }; return _extends.apply(this, arguments); }\n\nfunction _objectWithoutProperties(source, excluded) { if (source == null) return {}; var target = _objectWithoutPropertiesLoose(source, excluded); var key, i; if (Object.getOwnPropertySymbols) { var sourceSymbolKeys = Object.getOwnPropertySymbols(source); for (i = 0; i < sourceSymbolKeys.length; i++) { key = sourceSymbolKeys[i]; if (excluded.indexOf(key) >= 0) continue; if (!Object.prototype.propertyIsEnumerable.call(source, key)) continue; target[key] = source[key]; } } return target; }\n\nfunction _objectWithoutPropertiesLoose(source, excluded) { if (source == null) return {}; var target = {}; var sourceKeys = Object.keys(source); var key, i; for (i = 0; i < sourceKeys.length; i++) { key = sourceKeys[i]; if (excluded.indexOf(key) >= 0) continue; target[key] = source[key]; } return target; }\n\n/* @jsxRuntime classic */\n\n/* @jsx mdx */\nvar _frontmatter = {\n  \"title\": \"prometheus-prometheus-golang-memory-monitoring\"\n};\nvar layoutProps = {\n  _frontmatter: _frontmatter\n};\nvar MDXLayout = \"wrapper\";\nreturn function MDXContent(_ref) {\n  var components = _ref.components,\n      props = _objectWithoutProperties(_ref, [\"components\"]);\n\n  return mdx(MDXLayout, _extends({}, layoutProps, props, {\n    components: components,\n    mdxType: \"MDXLayout\"\n  }), mdx(\"h1\", null, \"Prometheus or Golang applicaions memory leak troubleshooting\"), mdx(\"ul\", null, mdx(\"li\", {\n    parentName: \"ul\"\n  }, mdx(\"a\", {\n    parentName: \"li\",\n    \"href\": \"#prometheus-or-golang-applicaions-memory-leak-troubleshooting\"\n  }, \"Prometheus or Golang applicaions memory leak troubleshooting\"), mdx(\"ul\", {\n    parentName: \"li\"\n  }, mdx(\"li\", {\n    parentName: \"ul\"\n  }, mdx(\"a\", {\n    parentName: \"li\",\n    \"href\": \"#1-environment-version--issue\"\n  }, \"1. Environment, version & issue\"), mdx(\"ul\", {\n    parentName: \"li\"\n  }, mdx(\"li\", {\n    parentName: \"ul\"\n  }, mdx(\"a\", {\n    parentName: \"li\",\n    \"href\": \"#11-environment\"\n  }, \"1.1. Environment\")), mdx(\"li\", {\n    parentName: \"ul\"\n  }, mdx(\"a\", {\n    parentName: \"li\",\n    \"href\": \"#12-issue\"\n  }, \"1.2. Issue\")))), mdx(\"li\", {\n    parentName: \"ul\"\n  }, mdx(\"a\", {\n    parentName: \"li\",\n    \"href\": \"#2-troubleshooting\"\n  }, \"2. Troubleshooting\"), mdx(\"ul\", {\n    parentName: \"li\"\n  }, mdx(\"li\", {\n    parentName: \"ul\"\n  }, mdx(\"a\", {\n    parentName: \"li\",\n    \"href\": \"#21-golang-version\"\n  }, \"2.1. Golang version\")), mdx(\"li\", {\n    parentName: \"ul\"\n  }, mdx(\"a\", {\n    parentName: \"li\",\n    \"href\": \"#22-does-it-affect-prometheus-memory-usage\"\n  }, \"2.2. Does it affect Prometheus memory usage?\")))), mdx(\"li\", {\n    parentName: \"ul\"\n  }, mdx(\"a\", {\n    parentName: \"li\",\n    \"href\": \"#3-choose-the-right-metric-for-prometheus-memory-monitoring\"\n  }, \"3. Choose the right metric for Prometheus memory monitoring\"))))), mdx(\"h2\", null, \"1. Environment, version & issue\"), mdx(\"h3\", null, \"1.1. Environment\"), mdx(\"ul\", null, mdx(\"li\", {\n    parentName: \"ul\"\n  }, \"Prometheus v2.1x.\"), mdx(\"li\", {\n    parentName: \"ul\"\n  }, \"Golang >= 1.12.\"), mdx(\"li\", {\n    parentName: \"ul\"\n  }, \"Cadvisor v0.35.0\"), mdx(\"li\", {\n    parentName: \"ul\"\n  }, \"Containerize.\"), mdx(\"li\", {\n    parentName: \"ul\"\n  }, \"Linux kernel 3.10.xxx\")), mdx(\"h3\", null, \"1.2. Issue\"), mdx(\"ul\", null, mdx(\"li\", {\n    parentName: \"ul\"\n  }, \"The memory leak might happen when Prometheus server receives a huge query. We expect its memory to come up then down.\"), mdx(\"li\", {\n    parentName: \"ul\"\n  }, \"Prometheus server memory usage is increasing without ever coming down. This might look like a leak or some bug in memory allocation. Even worse it looks like the container is just about to run OOM.\"), mdx(\"li\", {\n    parentName: \"ul\"\n  }, \"Prometheus keeps sending alerts.\"), mdx(\"li\", {\n    parentName: \"ul\"\n  }, \"Which metric is used? \", mdx(\"inlineCode\", {\n    parentName: \"li\"\n  }, \"container_memory_usage_bytes\"), \" and \", mdx(\"inlineCode\", {\n    parentName: \"li\"\n  }, \"container_memory_working_set_bytes\"), \".\")), mdx(\"h2\", null, \"2. Troubleshooting\"), mdx(\"h3\", null, \"2.1. Golang version\"), mdx(\"ul\", null, mdx(\"li\", {\n    parentName: \"ul\"\n  }, \"Started from version 1.12, Golang runtime now uses \", mdx(\"inlineCode\", {\n    parentName: \"li\"\n  }, \"MADV_FREE\"), \" to release unused memory, check \", mdx(\"a\", {\n    parentName: \"li\",\n    \"href\": \"https://golang.org/doc/go1.12#runtime\"\n  }, \"the release note\"), \":\")), mdx(\"pre\", null, mdx(\"code\", {\n    parentName: \"pre\"\n  }, \"MADV_DONTNEED -> MADV_FREE (if available)\\n\")), mdx(\"ul\", null, mdx(\"li\", {\n    parentName: \"ul\"\n  }, mdx(\"p\", {\n    parentName: \"li\"\n  }, \"Go deeper, Golang runtime uses \", mdx(\"a\", {\n    parentName: \"p\",\n    \"href\": \"https://man7.org/linux/man-pages/man2/madvise.2.html\"\n  }, \"madvise\"), \" system call - \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"give advice about use of memory\"), \". There are many advice values, but we are only care about these two:\"), mdx(\"ul\", {\n    parentName: \"li\"\n  }, mdx(\"li\", {\n    parentName: \"ul\"\n  }, mdx(\"inlineCode\", {\n    parentName: \"li\"\n  }, \"MADV_DONTNEED\"), \": Do not expect access in the near future. (For the time being, the application is finished with the given range, so the kernel can free resources associated with it).\"), mdx(\"li\", {\n    parentName: \"ul\"\n  }, mdx(\"inlineCode\", {\n    parentName: \"li\"\n  }, \"MADV_FREE\"), \" (\", mdx(\"strong\", {\n    parentName: \"li\"\n  }, \"since kernel 4.5\"), \"): The application no longer requires the pages in the range specified by addr and len. The kernel can thus free these pages, but the freeing could be delayed until memory pressure occurs.\"))), mdx(\"li\", {\n    parentName: \"ul\"\n  }, mdx(\"p\", {\n    parentName: \"li\"\n  }, mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"MADVISE_FREE\"), \" was added in Linux 4.5. Fall back to \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"MADV_DONTNEED\"), \" if it is not supported. Check the \", mdx(\"a\", {\n    parentName: \"p\",\n    \"href\": \"https://go-review.googlesource.com/c/go/+/135395\"\n  }, \"patch\"), \".\"))), mdx(\"p\", null, mdx(\"img\", {\n    parentName: \"p\",\n    \"src\": \"./imgs/runtime_madv_free.png\",\n    \"alt\": null\n  })), mdx(\"ul\", null, mdx(\"li\", {\n    parentName: \"ul\"\n  }, \"The kernel won't free resources associated with the given range until memory pressure occurs. Memory pressure means that other processes or the kernel itself do not have enough memory in the unused pool.\"), mdx(\"li\", {\n    parentName: \"ul\"\n  }, mdx(\"inlineCode\", {\n    parentName: \"li\"\n  }, \"Go runtime is reluctant to give memory pages back\"), \".\")), mdx(\"h3\", null, \"2.2. Does it affect Prometheus memory usage?\"), mdx(\"ul\", null, mdx(\"li\", {\n    parentName: \"ul\"\n  }, \"Go runtime is reluctant to give memory pages back so Prometheus memory usage won't be down if there are still enough resources in pool. It makes sense. But the used Linux kernel is just 3.10, it shouldn't act like that. Go runtime should fall back to use \", mdx(\"inlineCode\", {\n    parentName: \"li\"\n  }, \"MADV_DONTNEED\"), \".\"), mdx(\"li\", {\n    parentName: \"ul\"\n  }, \"Prometheus server is containerized so might it have a different behavior? \", mdx(\"em\", {\n    parentName: \"li\"\n  }, \"No, there's no kernel inside a container. Containers are processes, they also make system calls to the kernel\"), \". The behavior should be the same.\")), mdx(\"p\", null, mdx(\"img\", {\n    parentName: \"p\",\n    \"src\": \"https://www.redhat.com/cms/managed-files/styles/wysiwyg_full_width/s3/2015/07/user-space-vs-kernel-space-simple-container.png?itok=ptougYzT\",\n    \"alt\": null\n  })), mdx(\"ul\", null, mdx(\"li\", {\n    parentName: \"ul\"\n  }, \"To make sure, I use \", mdx(\"a\", {\n    parentName: \"li\",\n    \"href\": \"https://man7.org/linux/man-pages/man1/strace.1.html\"\n  }, \"strace\"), \" to trace system calls in the host. (No images here due to company privacy policies)\")), mdx(\"pre\", null, mdx(\"code\", {\n    parentName: \"pre\",\n    \"className\": \"language-bash\"\n  }, \"# Check kernel\\n$ uname -a\\nLinux hlc6fctl-2 3.10.0-957.5.1.el7.x86_64 #1 SMP Fri Feb 1 14:54:57 UTC 2019 x86_64 x86_64 x86_64 GNU/Linux\\n# Get prometheus pid first\\n$ ps aux | grep prometheus\\n# Strace\\n$ strace -p <pid> -e trace=madvise\\n# strace -p <pid> 2>&1 | grep madvise\\n\")), mdx(\"ul\", null, mdx(\"li\", {\n    parentName: \"ul\"\n  }, \"The result... Somehow it still uses \", mdx(\"inlineCode\", {\n    parentName: \"li\"\n  }, \"MADV_FREE\"), \" even the linux kernel is 3.10 :confused:\")), mdx(\"pre\", null, mdx(\"code\", {\n    parentName: \"pre\",\n    \"className\": \"language-bash\"\n  }, \"$ strace -p 22433 2>&1 | grep madvise\\nmadvise(0xcb708d0000, 8192, MADV_FREE)  = 0\\nmadvise(0xcb70860000, 8192, MADV_FREE)  = 0\\nmadvise(0xcb703ce000, 8192, MADV_FREE)  = 0\\nmadvise(0xcb7037c000, 8192, MADV_FREE)  = 0\\nmadvise(0xcb52fca000, 8192, MADV_FREE)  = 0\\nmadvise(0xcb52fba000, 8192, MADV_FREE)  = 0\\nmadvise(0xcb52f7c000, 8192, MADV_FREE)  = 0\\nmadvise(0xcb52eea000, 8192, MADV_FREE)  = 0\\nmadvise(0xcb52ee8000, 8192, MADV_FREE)  = 0\\nmadvise(0xcb52ee2000, 8192, MADV_FREE)  = 0\\nmadvise(0xcb52e88000, 8192, MADV_FREE)  = 0\\nmadvise(0xcb52d00000, 8192, MADV_FREE)  = 0\\nmadvise(0xcb52cf0000, 8192, MADV_FREE)  = 0\\nmadvise(0xcb52c24000, 8192, MADV_FREE)  = 0\\nmadvise(0xcb52b4c000, 8192, MADV_FREE)  = 0\\nmadvise(0xcb52b4a000, 8192, MADV_FREE)  = 0\\nmadvise(0xcb52b26000, 8192, MADV_FREE)  = 0\\nmadvise(0xcb52b22000, 8192, MADV_FREE)  = 0\\nmadvise(0xcb52a9a000, 8192, MADV_FREE)  = 0\\nmadvise(0xcb52a36000, 8192, MADV_FREE)  = 0\\nmadvise(0xcb529e4000, 8192, MADV_FREE)  = 0\\nmadvise(0xcb5289e000, 8192, MADV_FREE)  = 0\\nmadvise(0xcb5289c000, 8192, MADV_FREE)  = 0\\nmadvise(0xcb52896000, 8192, MADV_FREE)  = 0\\nmadvise(0xcb52836000, 8192, MADV_FREE)  = 0\\nmadvise(0xcb52810000, 8192, MADV_FREE)  = 0\\nmadvise(0xcb527ee000, 8192, MADV_FREE)  = 0\\nmadvise(0xcb527ec000, 8192, MADV_FREE)  = 0\\n\")), mdx(\"p\", null, mdx(\"img\", {\n    parentName: \"p\",\n    \"src\": \"https://i.pinimg.com/originals/95/02/20/950220f35e72e2b772b81e04a948173a.jpg\",\n    \"alt\": null\n  })), mdx(\"p\", null, mdx(\"img\", {\n    parentName: \"p\",\n    \"src\": \"https://i.ytimg.com/vi/rClNZLXSKA8/maxresdefault.jpg\",\n    \"alt\": null\n  })), mdx(\"ul\", null, mdx(\"li\", {\n    parentName: \"ul\"\n  }, \"I get stuck right there, but at least it explains everything - why Prometheus memory usage doesn't go down.\")), mdx(\"h2\", null, \"3. Choose the right metric for Prometheus memory monitoring\"), mdx(\"ul\", null, mdx(\"li\", {\n    parentName: \"ul\"\n  }, mdx(\"inlineCode\", {\n    parentName: \"li\"\n  }, \"container_memory_usage_bytes\"), \": \", mdx(\"em\", {\n    parentName: \"li\"\n  }, \"NOPE\"), \" - From the \", mdx(\"a\", {\n    parentName: \"li\",\n    \"href\": \"https://www.kernel.org/doc/Documentation/cgroup-v1/memory.txt\"\n  }, \"cgroup doc\"), \":\")), mdx(\"pre\", null, mdx(\"code\", {\n    parentName: \"pre\"\n  }, \"For efficiency, as other kernel components, memory cgroup uses some optimization to avoid unnecessary cacheline false sharing. usage_in_bytes is affected by the method and doesn\\u2019t show \\u2018exact\\u2019 value of memory (and swap) usage, it\\u2019s a fuzz value for efficient access. (Of course, when necessary, it\\u2019s synchronized.) If you want to know more exact memory usage, you should use RSS+CACHE(+SWAP) value in memory.stat(see 5.2).\\n\")), mdx(\"ul\", null, mdx(\"li\", {\n    parentName: \"ul\"\n  }, mdx(\"inlineCode\", {\n    parentName: \"li\"\n  }, \"container_memory_working_set_bytes\"), \": \", mdx(\"em\", {\n    parentName: \"li\"\n  }, \"BETTER BUT NOT ENOUGH\"), \" - It takes the fuzzy, still include cache/buffer.\")), mdx(\"pre\", null, mdx(\"code\", {\n    parentName: \"pre\",\n    \"className\": \"language-go\"\n  }, \"workingSet := ret.Memory.Usage\\n  if v, ok := s.MemoryStats.Stats[\\\"total_inactive_file\\\"]; ok {\\n    if workingSet < v {\\n      workingSet = 0\\n    } else {\\n      workingSet -= v\\n    }\\n  }\\n  ret.Memory.WorkingSet = workingSet\\n\")), mdx(\"ul\", null, mdx(\"li\", {\n    parentName: \"ul\"\n  }, mdx(\"inlineCode\", {\n    parentName: \"li\"\n  }, \"go_memstats_alloc_bytes\"), \" and others (\", mdx(\"inlineCode\", {\n    parentName: \"li\"\n  }, \"go_memstats_.*_inuse_byte\"), \"): \", mdx(\"em\", {\n    parentName: \"li\"\n  }, \"GOOD\"), \" - Get the actual allocations, it helps filter out the memory that is \\\"cached\\\". Note that \", mdx(\"inlineCode\", {\n    parentName: \"li\"\n  }, \"container_memory_.*_bytes\"), \" can have totally different update intervals to \", mdx(\"inlineCode\", {\n    parentName: \"li\"\n  }, \"go_memstats_.*_bytes\"), \" .\")));\n}\n;\nMDXContent.isMDXComponent = true;"},"inboundReferenceNotes":[{"title":"About these notes","slug":"about","childMdx":{"excerpt":"Hi, I'm  Kien Nguyen-Tuan  👋. prometheus-promql-gotchas prometheus-prometheus-promql-join prometheus-prometheus-labels-relabel prometheus…"}}],"outboundReferenceNotes":[]},"site":{"siteMetadata":{"title":"@kiennt's notes"}}},"pageContext":{"slug":"prometheus-prometheus-golang-memory-monitoring"}},"staticQueryHashes":[]}