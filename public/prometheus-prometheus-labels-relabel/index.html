<!DOCTYPE html><html><head><meta charSet="utf-8"/><meta http-equiv="x-ua-compatible" content="ie=edge"/><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"/><style data-href="/notes/styles.34c1555eaf028a1bf318.css" id="gatsby-global-css">.tippy-box[data-animation=shift-away][data-state=hidden]{opacity:0}.tippy-box[data-animation=shift-away][data-state=hidden][data-placement^=top]{transform:translateY(10px)}.tippy-box[data-animation=shift-away][data-state=hidden][data-placement^=bottom]{transform:translateY(-10px)}.tippy-box[data-animation=shift-away][data-state=hidden][data-placement^=left]{transform:translateX(10px)}.tippy-box[data-animation=shift-away][data-state=hidden][data-placement^=right]{transform:translateX(-10px)}</style><meta name="generator" content="Gatsby 3.2.0"/><link as="script" rel="preload" href="/notes/webpack-runtime-6ab9c6bdeef07b34c110.js"/><link as="script" rel="preload" href="/notes/framework-544fcf5a97337ccb1485.js"/><link as="script" rel="preload" href="/notes/app-180b2c4c68d8cb58bd57.js"/><link as="script" rel="preload" href="/notes/component---node-modules-gatsby-theme-andy-src-templates-note-js-f60ab987f54412c8d336.js"/><link as="fetch" rel="preload" href="/notes/page-data/prometheus-prometheus-labels-relabel/page-data.json" crossorigin="anonymous"/><link as="fetch" rel="preload" href="/notes/page-data/app-data.json" crossorigin="anonymous"/></head><body><script>(function() { try {
  var mode = localStorage.getItem('theme-ui-color-mode');
  if (!mode) return
  document.body.classList.add('theme-ui-' + mode);
} catch (e) {} })();</script><div id="___gatsby"><style data-emotion-css="n0ecfm">body{color:var(--theme-ui-colors-text,#333);background-color:var(--theme-ui-colors-background,#fff);}</style><style data-emotion-css="1fthmpb">*{box-sizing:border-box;}body{margin:0;font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",sans-serif;line-height:1.5;font-weight:400;}</style><div style="outline:none" tabindex="-1" id="gatsby-focus-wrapper"><style data-emotion-css="bya3fr">.css-bya3fr{-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;height:100vh;min-height:100vh;}</style><style data-emotion-css="1ehwac2">.css-1ehwac2{box-sizing:border-box;margin:0;min-width:0;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;height:100vh;min-height:100vh;}</style><div class="css-1ehwac2"><header><style data-emotion-css="b38cxh">.css-b38cxh{border-bottom:1px solid;border-color:var(--theme-ui-colors-gray,#dadada);}</style><style data-emotion-css="bjpuxf">.css-bjpuxf{box-sizing:border-box;margin:0;min-width:0;padding-top:8px;padding-bottom:8px;padding-left:16px;padding-right:16px;border-bottom:1px solid;border-color:var(--theme-ui-colors-gray,#dadada);}</style><div class="css-bjpuxf"><style data-emotion-css="12j45zb">.css-12j45zb{font-weight:700;color:var(--theme-ui-colors-text,#333);-webkit-text-decoration:none;text-decoration:none;}</style><a class="css-12j45zb" href="/notes/">@kiennt&#x27;s notes</a></div></header><style data-emotion-css="lxqeq9">.css-lxqeq9{-webkit-flex:1;-ms-flex:1;flex:1;-webkit-box-flex:1;-webkit-flex-grow:1;-ms-flex-positive:1;flex-grow:1;overflow-y:hidden;}@media screen and (min-width:768px){.css-lxqeq9{overflow-x:auto;}}</style><style data-emotion-css="1xopae2">.css-1xopae2{box-sizing:border-box;margin:0;min-width:0;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex:1;-ms-flex:1;flex:1;-webkit-box-flex:1;-webkit-flex-grow:1;-ms-flex-positive:1;flex-grow:1;overflow-y:hidden;}@media screen and (min-width:768px){.css-1xopae2{overflow-x:auto;}}</style><div class="css-1xopae2"><style data-emotion-css="9ms8w3">.css-9ms8w3{min-width:unset;-webkit-box-flex:1;-webkit-flex-grow:1;-ms-flex-positive:1;flex-grow:1;-webkit-transition-duration:100px;transition-duration:100px;width:100%;}@media screen and (min-width:640px){.css-9ms8w3{width:100%;}}@media screen and (min-width:768px){.css-9ms8w3{-webkit-transition:width;transition:width;width:1152px;}}</style><style data-emotion-css="1806l1h">.css-1806l1h{box-sizing:border-box;margin:0;min-width:0;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;min-width:unset;-webkit-box-flex:1;-webkit-flex-grow:1;-ms-flex-positive:1;flex-grow:1;-webkit-transition-duration:100px;transition-duration:100px;width:100%;}@media screen and (min-width:640px){.css-1806l1h{width:100%;}}@media screen and (min-width:768px){.css-1806l1h{-webkit-transition:width;transition:width;width:1152px;}}</style><div class="note-columns-container css-1806l1h"><style data-emotion-css="q7ai65">.css-q7ai65{-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;-webkit-flex-shrink:0;-ms-flex-negative:0;flex-shrink:0;overflow-y:auto;max-width:100%;width:100%;left:0;right:-585px;}@media screen and (min-width:640px){.css-q7ai65{max-width:100%;width:100%;}}@media screen and (min-width:768px){.css-q7ai65{position:-webkit-sticky;position:sticky;max-width:100vw;width:576px;}}</style><style data-emotion-css="108dckd">.css-108dckd{box-sizing:border-box;margin:0;min-width:0;padding-left:16px;padding-right:16px;background-color:var(--theme-ui-colors-background,#fff);display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;-webkit-flex-shrink:0;-ms-flex-negative:0;flex-shrink:0;overflow-y:auto;max-width:100%;width:100%;left:0;right:-585px;}@media screen and (min-width:640px){.css-108dckd{max-width:100%;width:100%;}}@media screen and (min-width:768px){.css-108dckd{position:-webkit-sticky;position:sticky;max-width:100vw;width:576px;}}</style><div class="note-container css-108dckd"><style data-emotion-css="qkbcne">.css-qkbcne{display:none;-webkit-transition:opacity;transition:opacity;-webkit-transition-duration:100px;transition-duration:100px;opacity:0;}@media screen and (min-width:640px){.css-qkbcne{display:none;}}@media screen and (min-width:768px){.css-qkbcne{display:block;}}</style><style data-emotion-css="1d4xrqf">.css-1d4xrqf{box-sizing:border-box;margin:0;min-width:0;display:none;-webkit-transition:opacity;transition:opacity;-webkit-transition-duration:100px;transition-duration:100px;opacity:0;}@media screen and (min-width:640px){.css-1d4xrqf{display:none;}}@media screen and (min-width:768px){.css-1d4xrqf{display:block;}}</style><div class="css-1d4xrqf"><style data-emotion-css="1557ki8">.css-1557ki8{position:absolute;z-index:10;-webkit-transform:rotate(90deg);-ms-transform:rotate(90deg);transform:rotate(90deg);-webkit-transform-origin:left;-ms-transform-origin:left;transform-origin:left;}</style><style data-emotion-css="1vxydnz">.css-1vxydnz{box-sizing:border-box;margin:0;min-width:0;padding-bottom:8px;position:absolute;z-index:10;-webkit-transform:rotate(90deg);-ms-transform:rotate(90deg);transform:rotate(90deg);-webkit-transform-origin:left;-ms-transform-origin:left;transform-origin:left;}</style><div class="css-1vxydnz"><style data-emotion-css="y5zp6v">.css-y5zp6v{font-weight:700;-webkit-text-decoration:none;text-decoration:none;color:var(--theme-ui-colors-text,#333);}</style><a class="css-y5zp6v" href="/notes/prometheus-prometheus-labels-relabel/prometheus-prometheus-labels-relabel">prometheus-prometheus-labels-relabel</a></div></div><style data-emotion-css="1jnayfl">.css-1jnayfl{-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;min-height:100%;-webkit-transition:opacity;transition:opacity;-webkit-transition-duration:100px;transition-duration:100px;opacity:1;}</style><style data-emotion-css="1xvlbb1">.css-1xvlbb1{box-sizing:border-box;margin:0;min-width:0;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;min-height:100%;-webkit-transition:opacity;transition:opacity;-webkit-transition-duration:100px;transition-duration:100px;opacity:1;}</style><div class="css-1xvlbb1"><style data-emotion-css="1rr4qq7">.css-1rr4qq7{-webkit-flex:1;-ms-flex:1;flex:1;}</style><div class="css-1rr4qq7"><style data-emotion-css="1ebprri">.css-1ebprri{margin-top:16px;margin-bottom:16px;}</style><style data-emotion-css="xz3bt">.css-xz3bt{color:#333;font-family:inherit;line-height:1.125;font-weight:700;font-size:32px;margin-top:16px;margin-bottom:16px;}</style><h1 class="css-xz3bt">prometheus-prometheus-labels-relabel</h1><style data-emotion-css="1ccy11i">.css-1ccy11i{color:#333;font-family:inherit;line-height:1.125;font-weight:700;font-size:32px;color:#333;font-family:inherit;line-height:1.125;font-weight:700;font-size:32px;}</style><h1 class="css-1ccy11i">Prometheus labels</h1><style data-emotion-css="cq6ij1">.css-cq6ij1{color:#333;font-family:inherit;line-height:1.125;font-weight:700;font-size:24px;color:#333;font-family:inherit;line-height:1.125;font-weight:700;font-size:24px;}</style><h2 class="css-cq6ij1">Labels</h2><ul class="css-0"><li class="css-0">Labels are a key part of Prometheus. and one of the things that make it powerful.</li><li class="css-0">Labels are key-value pairs associated with time series that in addition to the metric name uniquely identify them.</li><li class="css-0">Labels come from two sources, <em class="css-0">instrumentation labels</em> and <em class="css-0">target labels</em>.</li><li class="css-0">Instrumentation labels as the name indicates come from your instrumentation. They are about things that are known inside your application or library, such as the type HTTP requests it receives, which databases it talks to and other internals.</li><li class="css-0">Target labels identify a specific monitoring target, that is a target that Prometheus scrapes. They relate more to your architecture and may include which application it is, what datacenter it lives in, if it is in a development or production environment.</li><li class="css-0">Target labels come from service discovery and relabeling.</li></ul><h2 class="css-cq6ij1">Relabeling</h2><blockquote class="css-0"><style data-emotion-css="19iowwu">.css-19iowwu{color:#333;color:#333;}</style><p class="css-19iowwu">NOTE: These two following pictures was gotten from <style data-emotion-css="18ci6ln">.css-18ci6ln{color:#3182ce;-webkit-text-decoration:none;text-decoration:none;}.css-18ci6ln:hover{-webkit-text-decoration:underline;text-decoration:underline;}</style><a class="css-18ci6ln" href="https://www.robustperception.io/life-of-a-label">Life of label</a>. These one may be out-dated, based on Prometheus 0.17.0.</p></blockquote><style data-emotion-css="jgtg8i">.css-jgtg8i{color:#333;font-family:inherit;line-height:1.125;font-weight:700;font-size:20px;color:#333;font-family:inherit;line-height:1.125;font-weight:700;font-size:20px;}</style><h3 class="css-jgtg8i">relabel_configs</h3><p class="css-19iowwu"><style data-emotion-css="1k89gbo">.css-1k89gbo{max-width:100%;max-width:100%;}</style><img src="https://www.robustperception.io/wp-content/uploads/2016/03/Life-of-a-Label-Target-Labels-495x640.png" alt="relabel_configs" class="css-1k89gbo"/></p><h3 class="css-jgtg8i">metric_relabel_configs</h3><p class="css-19iowwu"><img src="https://www.robustperception.io/wp-content/uploads/2016/03/Life-of-a-Label-Scraping-445x640.png" alt="metrics_relabel_configs" class="css-1k89gbo"/></p><h3 class="css-jgtg8i">relabel_configs vs metric_relabel_configs</h3><ul class="css-0"><li class="css-0"><p class="css-19iowwu">Prometheus needs to know what to scrape, and that&#x27;s the where service discovery and <code class="css-0">relabel_configs</code> come in. Relabel configs allow you to select which targets you want to scraped, and what the target labels will be. So if you want to say scrape this type of machine but not that one, use <code class="css-0">relabel_configs</code>.</p></li><li class="css-0"><p class="css-19iowwu"><code class="css-0">metrics_relabel_configs</code> by contrast are applied after the scrape has happened, but before the data is ingested by the storage system. So if there are some expensive metrics you want to drop, or labels coming from the scrape itself that you want to manipulate that&#x27;s where <code class="css-0">metrics_relabel_configs</code> applies.</p></li><li class="css-0"><p class="css-19iowwu">So as a simple rule of thumb: <code class="css-0">relabel_configs</code> happens before the scrape, <code class="css-0">metrics_relabel_configs</code> happens after the scrape. And if one doesn&#x27;t work you can always try the other!</p></li></ul><h3 class="css-jgtg8i">Use cases</h3><p class="css-19iowwu">Check <a class="css-18ci6ln" href="https://medium.com/quiq-blog/prometheus-relabeling-tricks-6ae62c56cbda">Prometheus relabeling tricks</a></p><ul class="css-0"><li class="css-0">Drop unnecessary metrics</li></ul><style data-emotion-css="mwhsaa">.css-mwhsaa{font-family:Menlo,monospace;overflow-x:auto;font-family:Menlo,monospace;overflow-x:auto;}.css-mwhsaa code{color:inherit;}.css-mwhsaa code{color:inherit;}</style><pre class="css-mwhsaa"><style data-emotion-css="tej46y">.css-tej46y{font-family:Menlo,monospace;font-size:inherit;font-family:Menlo,monospace;font-size:inherit;}</style><code class="css-tej46y">- job_name: cadvisor
  ...
  metric_relabel_configs:
  - source_labels: [__name__]
    regex: &#x27;(container_tasks_state|container_memory_failures_total)&#x27;
    action: drop
</code></pre><ul class="css-0"><li class="css-0">Drop unnecessary time-series</li></ul><pre class="css-mwhsaa"><code class="css-tej46y">- job_name: cadvisor
  ...
  metric_relabel_configs:
  - source_labels: [id]
    regex: &#x27;/system.slice/var-lib-docker-containers.*-shm.mount&#x27;
    action: drop
  - source_labels: [container_label_JenkinsId]
    regex: &#x27;.+&#x27;
    action: drop
</code></pre><ul class="css-0"><li class="css-0">Drop sensitive or unwanted labels from metrics</li></ul><pre class="css-mwhsaa"><code class="css-tej46y">- job_name: cadvisor
  ...
  metric_relabel_configs:
  - regex: &#x27;container_label_com_amazonaws_ecs_task_arn&#x27;
    action: labeldrop
</code></pre><ul class="css-0"><li class="css-0">Amend label format of the final metrics</li></ul><pre class="css-mwhsaa"><code class="css-tej46y">- job_name: cadvisor
  ...
  metric_relabel_configs:
  - source_labels: [image]
    regex: &#x27;.*/(.*)&#x27;
    replacement: &#x27;$1&#x27;
    target_label: id
  - source_labels: [service]
    regex: &#x27;ecs-.*:ecs-([a-z]+-*[a-z]*).*:[0-9]+&#x27;
    replacement: &#x27;$1&#x27;
    target_label: service
</code></pre><h3 class="css-jgtg8i">Real-world use case</h3><ul class="css-0"><li class="css-0"><strong class="css-0">Scenario</strong>: You have OpenStack cluster and you want to monitor its instance metrics dynamically. Ok, assume you got all instance (per project) metrics but endpoint (and instance) was something like <code class="css-0">10.240.203.210:9100/...</code>. You are unable to know which instance when look at this. So let&#x27;s change this to instance name.</li></ul><pre class="css-mwhsaa"><code class="css-tej46y">- job_name: &#x27;openstack-node-exporter&#x27;
    openstack_sd_configs:
      - role: instance
        identity_endpoint: &#x27;...&#x27;
        username: &#x27;...&#x27;
        password: &#x27;...&#x27;
        domain_name: &#x27;...&#x27;
        port: 9100 # default node-exporter port
        refresh_interval: 20s
        region: &#x27;...&#x27;
        project_name: &#x27;...&#x27;
        all_tenants: true

    relabel_configs:
      # keep only acgive instances
      - source_labels: [__meta_openstack_instance_status]
        action: keep
        regex: ACTIVE

      # replace the default instance by the Openstack instance name
      - source_labels: [__meta_openstack_instance_name]
        target_label: instance

      # amend label format of the final metrics
      - source_labels: [__meta_openstack_tag_service]
        target_label: service
        replacement: $1
</code></pre></div><style data-emotion-css="rl6otz">.css-rl6otz{border-radius:8px;}</style><style data-emotion-css="19qk7ja">.css-19qk7ja{box-sizing:border-box;margin:0;min-width:0;padding:16px;margin-bottom:8px;background-color:#fafafc;color:#718096;border-radius:8px;}</style><div class="css-19qk7ja"><style data-emotion-css="rp57em">.css-rp57em{box-sizing:border-box;margin:0;min-width:0;font-family:inherit;font-weight:700;line-height:1.125;color:#718096;}</style><h4 class="css-rp57em">Referred in</h4><style data-emotion-css="19idom">.css-19idom{margin-bottom:8px;}</style><div class="css-19idom"><style data-emotion-css="ovwx2x">.css-ovwx2x{-webkit-text-decoration:none;text-decoration:none;color:#718096;}.css-ovwx2x:hover{color:#333;}</style><a class="css-ovwx2x" href="/notes/about"><style data-emotion-css="1jpm9pd">.css-1jpm9pd{padding-top:8px;padding-bottom:8px;}</style><div class="css-1jpm9pd"><style data-emotion-css="18iut6x">.css-18iut6x{font-size:16px;margin:0;color:#718096;}</style><style data-emotion-css="ouorfz">.css-ouorfz{color:#333;font-size:16px;margin:0;color:#718096;}</style><p class="css-ouorfz">About these notes</p><style data-emotion-css="uvfa58">.css-uvfa58{font-size:14px;margin:0;color:#718096;}</style><style data-emotion-css="1hddlwb">.css-1hddlwb{color:#333;font-size:14px;margin:0;color:#718096;}</style><p class="css-1hddlwb">Hi, I&#x27;m  Kien Nguyen-Tuan  👋. prometheus-promql-gotchas prometheus-prometheus-promql-join prometheus-prometheus-labels-relabel prometheus…</p></div></a></div><style data-emotion-css="4erca1">.css-4erca1{margin-left:auto;margin-right:auto;width:64px;}</style><hr class="css-4erca1"/><style data-emotion-css="1cev0y9">.css-1cev0y9{margin:0;font-size:14px;}</style><p class="css-1cev0y9">If you think this note resonated, be it positive or negative, please feel free to send me an<!-- --> <style data-emotion-css="15vz5gh">.css-15vz5gh{-webkit-text-decoration:underline;text-decoration:underline;color:#718096;}</style><style data-emotion-css="lnu7pe">.css-lnu7pe{color:#3182ce;-webkit-text-decoration:none;text-decoration:none;-webkit-text-decoration:underline;text-decoration:underline;color:#718096;}.css-lnu7pe:hover{-webkit-text-decoration:underline;text-decoration:underline;}</style><a href="mailto:kiennt2609@gmail.com" class="css-lnu7pe">email</a> <!-- -->and we can talk.</p></div></div></div></div></div></div></div><div id="gatsby-announcer" style="position:absolute;top:0;width:1px;height:1px;padding:0;overflow:hidden;clip:rect(0, 0, 0, 0);white-space:nowrap;border:0" aria-live="assertive" aria-atomic="true"></div></div><script id="gatsby-script-loader">/*<![CDATA[*/window.pagePath="/prometheus-prometheus-labels-relabel";/*]]>*/</script><script id="gatsby-chunk-mapping">/*<![CDATA[*/window.___chunkMapping={"polyfill":["/polyfill-534f3e0c52e5660f4540.js"],"app":["/app-180b2c4c68d8cb58bd57.js"],"component---node-modules-gatsby-theme-andy-src-templates-note-js":["/component---node-modules-gatsby-theme-andy-src-templates-note-js-f60ab987f54412c8d336.js"]};/*]]>*/</script><script src="/notes/polyfill-534f3e0c52e5660f4540.js" nomodule=""></script><script src="/notes/component---node-modules-gatsby-theme-andy-src-templates-note-js-f60ab987f54412c8d336.js" async=""></script><script src="/notes/app-180b2c4c68d8cb58bd57.js" async=""></script><script src="/notes/framework-544fcf5a97337ccb1485.js" async=""></script><script src="/notes/webpack-runtime-6ab9c6bdeef07b34c110.js" async=""></script></body></html>